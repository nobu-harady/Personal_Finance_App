<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>家計簿 - 新規登録</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; line-height: 1.6; padding: 20px; max-width: 700px; margin: auto; font-size: 18px; }
        form { display: flex; flex-direction: column; gap: 15px; }
        div { display: flex; flex-direction: column; }
        label { margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { padding: 15px; border: 1px solid #ccc; border-radius: 4px; font-size: 1.1em; }
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; }
        button:hover { background-color: #0056b3; }
        nav { margin-bottom: 20px; text-align: center; }
        nav a { margin: 0 15px; text-decoration: none; color: #007bff; font-weight: bold; }
        .chart-container { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 20px; }
        .chart-wrapper { width: 100%; max-width: 320px; text-align: center; }
        .radio-group { flex-direction: row; align-items: center; }
        .radio-group label { font-weight: normal; margin-right: 15px; margin-bottom: 0; }
        #message { margin-top: 15px; padding: 10px; border-radius: 4px; display: none; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-btn:hover, .close-btn:focus { color: black; text-decoration: none; cursor: pointer; }
    </style>
</head>
<body>
    <h1>家計簿アプリ</h1>

    <nav>
        <a href="/">収支バランス</a>
        <a href="/list">一覧・分析</a>
    </nav>

    <hr>

    <h2>直近1ヶ月間の収支バランス</h2>
    <div class="chart-container">
        <div class="chart-wrapper">
            <h3>収入</h3>
            <canvas id="income-chart"></canvas>
        </div>
        <div class="chart-wrapper">
            <h3>支出</h3>
            <canvas id="expense-chart"></canvas>
        </div>
    </div>

    <hr>

    <h2 id="register-section">新しい取引を登録</h2>
    <form id="transaction-form">
        <div>
            <label for="date">日付:</label>
            <input type="date" id="date" name="date" required>
        </div>

        <div class="radio-group">
            <label>種類:</label>
            <input type="radio" id="type-expense" name="type" value="expense" checked>
            <label for="type-expense">支出</label>
            <input type="radio" id="type-income" name="type" value="income">
            <label for="type-income">収入</label>
        </div>

        <div>
            <label for="category">カテゴリ:</label>
            <select id="category" name="category" required></select>
        </div>

        <div>
            <label for="amount">金額:</label>
            <input type="number" id="amount" name="amount" required min="1">
        </div>

        <div>
            <label for="memo">メモ:</label>
            <textarea id="memo" name="memo" rows="3"></textarea>
        </div>

        <button type="submit">登録</button>
    </form>

    <div id="message"></div>

    <hr style="margin-top: 30px;">

    <h2 id="history-section">取引履歴</h2>
    <table id="transaction-list">
        <thead>
            <tr>
                <th>日付</th>
                <th>種類</th>
                <th>カテゴリ</th>
                <th>金額</th>
                <th>メモ</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {{range .transactions}}
            <tr>
                <td>{{.Date.Format "2006-01-02"}}</td>
                <td>{{if eq .Type "income"}}<span class="amount-income">収入</span>{{else}}<span class="amount-expense">支出</span>{{end}}</td>
                <td>{{.Category}}</td>
                <td class="{{if eq .Type "income"}}amount-income{{else}}amount-expense{{end}}">{{.Amount}}円</td>
                <td>{{.Memo}}</td>
                <td class="actions">
                    <button class="edit-btn" data-id="{{.ID}}">編集</button>
                    <button class="delete-btn" data-id="{{.ID}}">削除</button>
                </td>
            </tr>
            {{end}}
        </tbody>
    </table>

    <!-- Edit Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <span id="close-modal-btn" class="close-btn">&times;</span>
            <h2>取引を編集</h2>
            <form id="edit-form">
                <input type="hidden" id="edit-id" name="id">
                <div>
                    <label for="edit-date">日付:</label>
                    <input type="date" id="edit-date" name="date" required>
                </div>
        
                <div class="radio-group">
                    <label>種類:</label>
                    <input type="radio" id="edit-type-expense" name="type" value="expense">
                    <label for="edit-type-expense">支出</label>
                    <input type="radio" id="edit-type-income" name="type" value="income">
                    <label for="edit-type-income">収入</label>
                </div>
        
                <div>
                    <label for="edit-category">カテゴリ:</label>
                    <select id="edit-category" name="category" required></select>
                </div>
        
                <div>
                    <label for="edit-amount">金額:</label>
                    <input type="number" id="edit-amount" name="amount" required min="1">
                </div>
        
                <div>
                    <label for="edit-memo">メモ:</label>
                    <textarea id="edit-memo" name="memo" rows="3"></textarea>
                </div>
                <button type="submit">更新</button>
            </form>
        </div>
    </div>

    <script>
        const expenseCategories = [
            "食費", "日用品","家賃", "医療ローン", "保険", "サブスク", "ショッピング分割", "光熱費","交通費", "スキルアップ", "仕事用品", "医療", "美容", "娯楽", "その他（支出）"
        ];
        const incomeCategories = ["給与", "賞与", "販売", "その他（収入）"];

        const typeRadios = document.querySelectorAll('input[name="type"]');
        const categorySelect = document.getElementById('category');
        const form = document.getElementById('transaction-form');
        const messageDiv = document.getElementById('message');
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-form');
        const closeModalBtn = document.getElementById('close-modal-btn');


        function updateCategories() {
            const selectedType = document.querySelector('input[name="type"]:checked').value;
            const categories = selectedType === 'income' ? incomeCategories : expenseCategories;
            
            categorySelect.innerHTML = ''; // Clear existing options
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categorySelect.appendChild(option);
            });
        }

        function updateEditCategories() {
            // 編集フォーム内のラジオボタンから値を取得するようにセレクタを修正
            const selectedTypeRadio = document.querySelector('#edit-form input[name="type"]:checked');
            if (!selectedTypeRadio) return; // モーダルが初期化されていない場合は何もしない
            const selectedType = selectedTypeRadio.value;
            const categories = selectedType === 'income' ? incomeCategories : expenseCategories;
            const editCategorySelect = document.getElementById('edit-category');
            
            editCategorySelect.innerHTML = ''; // Clear existing options
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                editCategorySelect.appendChild(option);
            });
        }

        // 登録フォームと編集フォームのイベントリスナーを明確に分離
        document.querySelectorAll('#transaction-form input[name="type"]').forEach(radio => radio.addEventListener('change', updateCategories));
        document.querySelectorAll('#edit-form input[name="type"]').forEach(radio => radio.addEventListener('change', updateEditCategories));

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            messageDiv.style.display = 'none';

            const formData = new FormData(form);
            const dateValue = formData.get('date');
            // タイムゾーンの問題を避けるため、日付文字列をUTCとして解釈させる
            const date = new Date(dateValue + 'T00:00:00Z');

            const data = {
                date: date.toISOString(),
                type: formData.get('type'),
                category: formData.get('category'),
                amount: parseInt(formData.get('amount'), 10),
                memo: formData.get('memo')
            };

            try {
                const response = await fetch('/transactions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || '登録に失敗しました。');
                
                messageDiv.textContent = '登録が完了しました！';
                messageDiv.className = 'success';
                form.reset();
                // 登録成功後、ページをリロードしてリストを更新
                window.location.reload();
            } catch (error) {
                messageDiv.textContent = `エラー: ${error.message}`;
                messageDiv.className = 'error';
            } finally {
                messageDiv.style.display = 'block';
            }
        });

        // イベントリスナーをテーブルに設定（編集と削除を委任）
        document.getElementById('transaction-list')?.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-btn')) {
                const id = e.target.dataset.id;
                if (confirm(`ID: ${id} の取引を本当に削除しますか？`)) {
                    try {
                        const response = await fetch(`/transactions/${id}`, {
                            method: 'DELETE',
                        });
                        if (!response.ok) {
                            throw new Error('削除に失敗しました。');
                        }
                        // 削除成功後、ページをリロードしてリストを更新
                        window.location.reload();
                    } catch (error) {
                        alert(error.message);
                    }
                }
            } else if (e.target.classList.contains('edit-btn')) {
                const id = e.target.dataset.id;
                openEditModal(id);
            }
        });

        async function openEditModal(id) {
            try {
                const response = await fetch(`/transactions/${id}`);
                if (!response.ok) throw new Error('取引データの取得に失敗しました。');
                const { data } = await response.json();

                // Populate the modal form
                document.getElementById('edit-id').value = data.ID;
                // JSONレスポンスのフィールド名 (小文字) を参照するように修正
                document.getElementById('edit-date').value = data.date.substring(0, 10);
                document.getElementById(`edit-type-${data.type}`).checked = true;
                
                // Update categories before setting the value
                updateEditCategories();
                document.getElementById('edit-category').value = data.category;

                document.getElementById('edit-amount').value = data.amount;
                document.getElementById('edit-memo').value = data.memo;

                editModal.style.display = 'block';
            } catch (error) {
                alert(error.message);
            }
        }

        function closeEditModal() {
            editModal.style.display = 'none';
        }

        closeModalBtn.addEventListener('click', closeEditModal);
        window.addEventListener('click', (e) => {
            if (e.target == editModal) {
                closeEditModal();
            }
        });

        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const dateValue = document.getElementById('edit-date').value;
            // タイムゾーンの問題を避けるため、日付文字列をUTCとして解釈させる
            const date = new Date(dateValue + 'T00:00:00Z');

            const data = {
                date: date.toISOString(),
                // 編集フォーム内のラジオボタンから値を取得するようにセレクタを修正
                type: document.querySelector('#edit-form input[name="type"]:checked').value,
                category: document.getElementById('edit-category').value,
                amount: parseInt(document.getElementById('edit-amount').value, 10),
                memo: document.getElementById('edit-memo').value
            };

            try {
                const response = await fetch(`/transactions/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!response.ok) {
                    const result = await response.json();
                    throw new Error(result.error || '更新に失敗しました。');
                }
                window.location.reload();
            } catch (error) {
                alert(`エラー: ${error.message}`);
            }
        });

        // Initial setup
        document.getElementById('date').valueAsDate = new Date();
        updateCategories();

        // 円グラフ描画のヘルパー関数
        function createPieChart(canvasId, summaryData) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');

            if (!summaryData || summaryData.length === 0) {
                canvas.style.display = 'none';
                const wrapper = canvas.parentElement;
                const noDataMsg = document.createElement('p');
                noDataMsg.textContent = 'データがありません';
                wrapper.appendChild(noDataMsg);
                return;
            }

            const labels = summaryData.map(item => item.category);
            const data = summaryData.map(item => item.total);

            const chartColors = [ '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#E7E9ED', '#8DDF3C', '#F178B4', '#6A2E35', '#C4D7F2', '#A2D4AB' ];

            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: chartColors.slice(0, data.length),
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { 
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const dataArray = context.chart.data.datasets[0].data;
                                    const total = dataArray.reduce((sum, current) => sum + current, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%';
                                    return `${label}: ${value.toLocaleString()}円 (${percentage})`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 支出円グラフの描画
        const expenseSummary = [
            {{range .expenseSummary}}
            { category: "{{.Category}}", total: {{.Total}} },
            {{end}}
        ];
        createPieChart('expense-chart', expenseSummary);

        // 収入円グラフの描画
        const incomeSummary = [
            {{range .incomeSummary}}
            { category: "{{.Category}}", total: {{.Total}} },
            {{end}}
        ];
        createPieChart('income-chart', incomeSummary);

        // 棒グラフの描画
        const barChartCanvas = document.getElementById('monthly-expense-bar-chart');
        try {
            const barChartData = JSON.parse('{{.barChartDataJSON | js}}');

            if (barChartData && barChartData.datasets && barChartData.datasets.length > 0) {
                const barCtx = barChartCanvas.getContext('2d');
                new Chart(barCtx, {
                    type: 'bar',
                    data: barChartData,
                    options: {
                        plugins: {
                            title: {
                                display: true,
                                text: 'カテゴリ別 月次支出'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) { label += ': '; }
                                        if (context.parsed.y !== null) {
                                            label += context.parsed.y.toLocaleString() + '円';
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        responsive: true,
                        scales: {
                            x: { stacked: true },
                            y: {
                                stacked: true,
                                ticks: { callback: function(value) { return value.toLocaleString() + '円'; } }
                            }
                        }
                    }
                });
            } else {
                throw new Error("No data");
            }
        } catch (e) {
            barChartCanvas.style.display = 'none';
            const wrapper = barChartCanvas.parentElement;
            const noDataMsg = document.createElement('p');
            noDataMsg.textContent = '棒グラフのデータがありません';
            wrapper.appendChild(noDataMsg);
        }
    </script>
</body>
</html>